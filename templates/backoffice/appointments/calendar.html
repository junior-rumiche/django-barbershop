{% extends 'base/backoffice/base.html' %}
{% load static %}

{% block styles %}
<!-- FullCalendar CSS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        /* Luxury Color Palette */
        --luxury-gold: #c5a059;
        --luxury-gold-soft: rgba(197, 160, 89, 0.1);
        
        --glass-bg: rgba(255, 255, 255, 0.7);
        --glass-border: rgba(231, 234, 243, 0.7);
        
        --status-req-bg: rgba(255, 193, 7, 0.12);
        --status-req-border: #ffc107;
        --status-req-text: #856404;
        
        --status-conf-bg: rgba(67, 94, 190, 0.12);
        --status-conf-border: #435ebe;
        --status-conf-text: #25396f;
        
        --status-comp-bg: rgba(25, 135, 84, 0.12);
        --status-comp-border: #198754;
        --status-comp-text: #0f5132;
        
        --status-canc-bg: rgba(220, 53, 69, 0.08);
        --status-canc-border: rgba(220, 53, 69, 0.4);
        --status-canc-text: #842029;
    }

    body {
        font-family: 'Inter', sans-serif;
    }

    h3, h4, .fc-toolbar-title {
        font-family: 'Outfit', sans-serif !important;
        font-weight: 700 !important;
        letter-spacing: -0.02em;
    }

    #calendar-container {
        background: #fff;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.04);
        border: 1px solid var(--glass-border);
    }
    
    /* Elegant Event Cards (Glassmorphism inspired) */
    .fc-event {
        cursor: pointer;
        border: none !important;
        border-radius: 10px !important;
        background: transparent !important;
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1) !important;
        margin-bottom: 6px !important;
        overflow: hidden;
        width: 100% !important; /* Force 100% width */
        display: block !important;
    }

    .fc-daygrid-event-harness {
        margin: 2px 0 4px 0 !important; /* Remove horizontal margins */
    }

    .fc-daygrid-day-events {
        padding: 0 4px !important; /* Small padding within cell */
    }
    
    .fc-event:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 24px rgba(0,0,0,0.08) !important;
        z-index: 20 !important;
    }

    .fc-event-content-custom {
        padding: 10px 12px;
        display: flex;
        flex-direction: column;
        gap: 6px;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.4);
        border-left: 4px solid transparent;
        height: 100%;
        width: 100% !important;
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .event-time {
        font-weight: 800;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        opacity: 0.8;
    }

    .event-amount {
        font-family: 'Outfit', sans-serif;
        font-weight: 700;
        font-size: 0.85rem;
    }

    .event-title {
        font-weight: 700;
        font-size: 0.95rem;
        line-height: 1.3;
        color: #1e293b;
        margin: 2px 0;
    }

    .event-footer {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 0.72rem;
        font-weight: 600;
        opacity: 0.7;
    }

    /* Professional Status Styling */
    .evt-requested .fc-event-content-custom { background: var(--status-req-bg); border-left-color: var(--status-req-border); }
    .evt-requested .event-time, .evt-requested .event-amount { color: var(--status-req-text); }
    
    .evt-confirmed .fc-event-content-custom { background: var(--status-conf-bg); border-left-color: var(--status-conf-border); }
    .evt-confirmed .event-time, .evt-confirmed .event-amount { color: var(--status-conf-text); }

    .evt-completed .fc-event-content-custom { background: var(--status-comp-bg); border-left-color: var(--status-comp-border); }
    .evt-completed .event-time, .evt-completed .event-amount { color: var(--status-comp-text); }

    .evt-canceled .fc-event-content-custom { background: var(--status-canc-bg); border-left-color: var(--status-canc-border); filter: grayscale(0.5); }
    .evt-canceled .event-time, .evt-canceled .event-amount { color: var(--status-canc-text); }

    /* Minimalist Grid */
    .fc-theme-standard .fc-scrollgrid {
        border: none !important;
    }
    .fc-col-header-cell {
        background: transparent !important;
        padding: 20px 0 !important;
        border: none !important;
    }
    .fc-col-header-cell-cushion {
        color: #94a3b8 !important;
        font-weight: 800 !important;
        text-transform: uppercase;
        font-size: 0.7rem;
        letter-spacing: 1.5px;
        text-decoration: none !important;
    }

    .fc-day {
        border-color: #f1f5f9 !important;
    }

    .fc-daygrid-day-number {
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
        color: #64748b !important;
        padding: 12px !important;
        text-decoration: none !important;
        font-size: 0.9rem;
    }

    .fc-day-today {
        background-color: #fcfdfe !important;
    }
    .fc-day-today .fc-daygrid-day-number {
        color: var(--luxury-gold) !important;
        font-weight: 800;
        font-size: 1.1rem;
    }

    /* Custom Navbar Buttons */
    .fc-button-primary {
        background: #fff !important;
        border: 1px solid #e2e8f0 !important;
        color: #475569 !important;
        font-weight: 700 !important;
        font-size: 0.8rem !important;
        text-transform: uppercase !important;
        letter-spacing: 0.5px !important;
        padding: 10px 18px !important;
        border-radius: 12px !important;
        transition: all 0.2s !important;
    }
    .fc-button-primary:hover {
        background: #f8fafc !important;
        border-color: #cbd5e1 !important;
        color: #1e293b !important;
        transform: translateY(-1px);
    }
    .fc-button-active {
        background: #1e293b !important;
        border-color: #1e293b !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(30, 41, 59, 0.2) !important;
    }

    @media (max-width: 768px) {
        #calendar-container { padding: 15px; border-radius: 0; }
        .fc-toolbar { flex-direction: column; gap: 15px; }
    }
</style>
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-heading">
    <div class="page-title">
        <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>{{ page_title }}</h3>
                <p class="text-subtitle text-muted">Vista mensual y semanal de citas.</p>
            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'backoffice:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'backoffice:appointment_list' %}">Citas</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Calendario</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <section class="section">
        <div class="card">
            <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3">
                <h4 class="card-title mb-0">Calendario</h4>
                <div class="d-flex gap-2 w-auto">
                     <a href="{% url 'backoffice:appointment_list' %}" class="btn btn-secondary flex-fill flex-md-grow-0">
                        <i class="bi bi-list-ul"></i> Vista de Lista
                     </a>
                     {% if perms.backoffice.add_appointment %}
                     <a href="{% url 'backoffice:appointment_add' %}" class="btn btn-primary flex-fill flex-md-grow-0">
                        <i class="bi bi-plus-lg"></i> Nueva Cita
                     </a>
                     {% endif %}
                </div>
            </div>
            <div class="card-body">
                <div id='calendar'></div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script>
    /**
     * Initializes FullCalendar with localized settings and custom event rendering.
     * Uses snake_case for all JavaScript variables as per coding standards.
     */
    document.addEventListener('DOMContentLoaded', function() {
        const calendar_el = document.getElementById('calendar');
        const is_mobile = window.innerWidth < 768;
        
        /** @type {FullCalendar.Calendar} */
        const calendar = new FullCalendar.Calendar(calendar_el, {
            initialView: is_mobile ? 'timeGridDay' : 'dayGridMonth',
            locale: 'es',
            firstDay: 1,
            headerToolbar: {
                left: is_mobile ? 'prev,next' : 'prev,next today',
                center: 'title',
                right: is_mobile ? 'timeGridDay,listDay' : 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Hoy',
                month: 'Mes',
                week: 'Semana',
                day: 'DÃ­a',
                list: 'Lista'
            },
            eventTimeFormat: {
                hour: '2-digit',
                minute: '2-digit',
                meridiem: 'short'
            },
            events: '{% url "backoffice:appointment_events" %}',
            
            /**
             * Renders custom HTML content for calendar events
             * @param {object} arg - FullCalendar event object
             * @returns {object} DOM nodes for rendering
             */
            eventContent: function(arg) {
                const date = arg.event.start;
                let hours = date.getHours();
                let minutes = date.getMinutes();
                const ampm = hours >= 12 ? 'pm' : 'am';
                hours = hours % 12;
                hours = hours ? hours : 12;
                minutes = minutes < 10 ? '0' + minutes : minutes;
                const time_text = `${hours}:${minutes} ${ampm}`;

                const title = arg.event.title; 
                const raw_status = arg.event.extendedProps.status;
                const amount = arg.event.extendedProps.amount;

                // Create content
                const content = document.createElement('div');
                content.classList.add('fc-event-content-custom');
                
                content.innerHTML = `
                    <div class="event-header">
                        <span class="event-time">${time_text}</span>
                        <span class="event-amount">S/.${amount}</span>
                    </div>
                    <div class="event-title text-truncate">${title}</div>
                    <div class="event-footer">
                        <span>${raw_status.split(' ')[0]}</span>
                    </div>
                `;
                
                return { domNodes: [content] }
            },

            /**
             * Handles post-render logic (tooltips and status classes)
             * @param {object} info - Event mount info
             */
            eventDidMount: function(info) {
                const status = info.event.extendedProps.status;
                const phone = info.event.extendedProps.phone;
                const amount = info.event.extendedProps.amount;
                
                // Add status-based class
                let status_class = 'evt-requested';
                if (status.includes('Confirmada')) status_class = 'evt-confirmed';
                if (status.includes('Completada')) status_class = 'evt-completed';
                if (status.includes('Cancelada')) status_class = 'evt-canceled';
                
                info.el.classList.add(status_class);
                info.el.title = `Cliente: ${info.event.title}\nEstado: ${status}\nTel: ${phone}\nTotal: S/.${amount}`;
            },

            /**
             * Redirects to the edit page when an event is clicked
             * @param {object} info - Click event info
             */
            eventClick: function(info) {
                const edit_url = "{% url 'backoffice:appointment_edit' 0 %}".replace('0', info.event.id);
                window.location.href = edit_url;
            },

            /**
             * Dynamic view switching based on screen size
             */
            windowResize: function(view) {
                if (window.innerWidth < 768) {
                    calendar.changeView('timeGridDay');
                    calendar.setOption('headerToolbar', {
                        left: 'prev,next',
                        center: 'title',
                        right: 'timeGridDay,listDay'
                    });
                } else {
                    calendar.changeView('dayGridMonth');
                     calendar.setOption('headerToolbar', {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    });
                }
            }
        });
        calendar.render();
    });
</script>
{% endblock %}
