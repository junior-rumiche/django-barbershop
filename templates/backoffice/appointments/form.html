{% extends 'base/backoffice/base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'backoffice/extensions/flatpickr/flatpickr.min.css' %}">
<link rel="stylesheet" href="{% static 'backoffice/extensions/choices.js/public/assets/styles/choices.css' %}">
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-heading">
    <div class="page-title">
        <div class="row">
            <div class="col-12 col-md-6 order-md-1 order-last">
                <h3>{{ page_title }}</h3>
                <p class="text-subtitle text-muted">Complete el formulario para agendar o editar la cita.</p>
            </div>
            <div class="col-12 col-md-6 order-md-2 order-first">
                <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'backoffice:dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item"><a href="{% url 'backoffice:appointment_list' %}">Agenda</a></li>
                        <li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <section id="basic-vertical-layouts">
        <div class="row match-height">
            <div class="col-12">
                <div class="card">
                    <div class="card-content">
                        <div class="card-body">
                            <form class="form form-vertical" method="post">
                                {% csrf_token %}
                                <div class="form-body">
                                    <div class="row">
                                        {% if form.non_field_errors %}
                                        <div class="col-12">
                                            <div class="alert alert-danger">
                                                {{ form.non_field_errors }}
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Cliente -->
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.client_name.id_for_label }}">{{ form.client_name.label }}</label>
                                                {{ form.client_name }}
                                                {% if form.client_name.errors %}
                                                <div class="invalid-feedback d-block">{{ form.client_name.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.client_phone.id_for_label }}">{{ form.client_phone.label }}</label>
                                                {{ form.client_phone }}
                                                {% if form.client_phone.errors %}
                                                <div class="invalid-feedback d-block">{{ form.client_phone.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Cita Info -->
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.barber.id_for_label }}">{{ form.barber.label }}</label>
                                                {{ form.barber }}
                                                {% if form.barber.errors %}
                                                <div class="invalid-feedback d-block">{{ form.barber.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.status.id_for_label }}">{{ form.status.label }}</label>
                                                {{ form.status }}
                                                {% if form.status.errors %}
                                                <div class="invalid-feedback d-block">{{ form.status.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="col-12">
                                            <div class="form-group">
                                                <label for="{{ form.services.id_for_label }}">{{ form.services.label }}</label>
                                                {{ form.services }}
                                                {% if form.services.errors %}
                                                <div class="invalid-feedback d-block">{{ form.services.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <!-- Fecha y Hora -->
                                        <div class="col-md-4 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
                                                {{ form.date }}
                                                {% if form.date.errors %}
                                                <div class="invalid-feedback d-block">{{ form.date.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.start_time.id_for_label }}">{{ form.start_time.label }}</label>
                                                {{ form.start_time }}
                                                {% if form.start_time.errors %}
                                                <div class="invalid-feedback d-block">{{ form.start_time.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.end_time.id_for_label }}">{{ form.end_time.label }}</label>
                                                {{ form.end_time }}
                                                {% if form.end_time.errors %}
                                                <div class="invalid-feedback d-block">{{ form.end_time.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="col-md-6 col-12">
                                            <div class="form-group">
                                                <label for="{{ form.total_amount.id_for_label }}">{{ form.total_amount.label }}</label>
                                                {{ form.total_amount }}
                                                {% if form.total_amount.errors %}
                                                <div class="invalid-feedback d-block">{{ form.total_amount.errors.as_text }}</div>
                                                {% endif %}
                                            </div>
                                        </div>


                                        <div class="col-12 d-flex justify-content-end mt-3">
                                            <a href="{% url 'backoffice:appointment_list' %}"
                                                class="btn btn-light-secondary me-1 mb-1">
                                                <i class="bi bi-x-circle me-2"></i>
                                                Cancelar
                                            </a>
                                            <button type="submit" class="btn btn-primary me-1 mb-1">
                                                <i class="bi bi-check-circle me-2"></i>
                                                Guardar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'backoffice/extensions/flatpickr/flatpickr.min.js' %}"></script>
<script src="{% static 'backoffice/extensions/choices.js/public/assets/scripts/choices.js' %}"></script>
<script>
    /**
     * Initialize date pickers for general date fields
     */
    flatpickr(".flatpickr-date", {
        dateFormat: "Y-m-d",
        allowInput: true,
        {% if not form.instance.pk %}
        minDate: "today",
        {% endif %}
    });

    /**
     * Initialize End Time Picker
     * Configured for 12-hour format with AM/PM
     * @type {object}
     */
    const end_picker = flatpickr("#id_end_time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K", // Send "02:00 PM" to server
        time_24hr: false,
        allowInput: true
    });

    /**
     * Initialize Start Time Picker
     * Configured for 12-hour format. Updates End Time minTime and totals on change.
     * @type {object}
     */
    const start_picker = flatpickr("#id_start_time", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "h:i K", // Send "02:00 PM" to server
        time_24hr: false,
        allowInput: true,
        onChange: function(selected_dates, date_str, instance) {
            // Update end time minTime
            if (end_picker) {
                end_picker.set("minTime", date_str);
            }
            // Recalculate totals when start time changes
            calculate_totals();
        }
    });

    /**
     * Fallback for other time inputs (e.g. WorkSchedule)
     * Keeps 24h format for backend compatibility but shows 12h
     */
    flatpickr(".flatpickr-time:not(#id_start_time):not(#id_end_time)", {
        enableTime: true,
        noCalendar: true,
        dateFormat: "H:i", // Send 24h
        altInput: true,
        altFormat: "h:i K", // Show 12h
        time_24hr: false,
        allowInput: true
    });

    // --- Global Variables for Calculation ---
    const services_data = JSON.parse('{{ services_json|escapejs }}');
    const total_amount_input = document.getElementById('id_total_amount');
    const start_input = document.getElementById('id_start_time');
    const end_input = document.getElementById('id_end_time');

    /**
     * Parses a time string into a Date object (using today's date)
     * @param {string} time_str - Time string (e.g., "02:30 PM")
     * @returns {Date|null} Date object or null if parsing fails
     */
    function parse_time(time_str) {
        // time_str example: "02:30 PM"
        const [time, period] = time_str.split(' ');
        if (!time || !period) return null;
        
        let [hours, minutes] = time.split(':').map(Number);
        if (isNaN(hours) || isNaN(minutes)) return null;

        if (period.toUpperCase() === 'PM' && hours < 12) hours += 12;
        if (period.toUpperCase() === 'AM' && hours === 12) hours = 0;

        const date = new Date();
        date.setHours(hours, minutes, 0, 0);
        return date;
    }

    /**
     * Formats a Date object to "hh:mm K" string
     * @param {Date} date_obj - Date object to format
     * @returns {string} Formatted time string (e.g., "02:30 PM")
     */
    function format_time(date_obj) {
        let hours = date_obj.getHours();
        let minutes = date_obj.getMinutes();
        const ampm = hours >= 12 ? 'PM' : 'AM';
        
        hours = hours % 12;
        hours = hours ? hours : 12; 
        minutes = minutes < 10 ? '0' + minutes : minutes;
        
        return `${hours}:${minutes} ${ampm}`;
    }

    /**
     * Calculates total amount and estimated end time based on selected services
     * Triggered by changes in Service selection or Start Time
     */
    function calculate_totals() {
        const services_select = document.getElementById('id_services');
        const selected_options = Array.from(services_select.selectedOptions);
        
        let total_amount = 0;
        let total_duration = 0;

        selected_options.forEach(option => {
            const data = services_data[option.value];
            if (data) {
                total_amount += data.price;
                total_duration += data.duration;
            }
        });

        if (total_amount_input) {
            total_amount_input.value = total_amount.toFixed(2);
        }

        const start_time_str = start_input.value; 
        if (start_time_str && total_duration > 0) {
            const date_obj = parse_time(start_time_str);
            if (date_obj) {
                date_obj.setMinutes(date_obj.getMinutes() + total_duration);
                const end_time_str = format_time(date_obj);
                
                if (end_picker) {
                    end_picker.setDate(end_time_str, true); 
                } else if (end_input) {
                    end_input.value = end_time_str;
                }
            }
        }
    }

    let choices_elements = document.querySelectorAll('.choices');
    
    for (let i = 0; i < choices_elements.length; i++) {
        const el = choices_elements[i];
        let init_choice;
        
        if (el.classList.contains("multiple-remove")) {
            init_choice = new Choices(el, {
                delimiter: ',',
                editItems: true,
                maxItemCount: -1,
                removeItemButton: true,
            });
            el.addEventListener('change', calculate_totals);
        } else {
            init_choice = new Choices(el);
        }
    }
</script>
{% endblock %}
