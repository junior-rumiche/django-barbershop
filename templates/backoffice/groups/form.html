{% extends 'base/backoffice/base.html' %}
{% load static %}

{% block styles %}
<link rel="stylesheet" href="{% static 'backoffice/extensions/choices.js/public/assets/styles/choices.css' %}">
{% endblock %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="page-heading">
   <div class="page-title">
      <div class="row">
         <div class="col-12 col-md-6 order-md-1 order-last">
            <h3>{{ page_title }}</h3>
            <p class="text-subtitle text-muted">Completa el formulario para guardar la informaci√≥n del grupo.</p>
         </div>
         <div class="col-12 col-md-6 order-md-2 order-first">
            <nav aria-label="breadcrumb" class="breadcrumb-header float-start float-lg-end">
               <ol class="breadcrumb">
                  <li class="breadcrumb-item"><a href="{% url 'backoffice:dashboard' %}">Dashboard</a></li>
                  <li class="breadcrumb-item"><a href="{% url 'backoffice:group_list' %}">Grupos</a></li>
                  <li class="breadcrumb-item active" aria-current="page">{{ page_title }}</li>
               </ol>
            </nav>
         </div>
      </div>
   </div>

   <section class="section">
      <div class="card">
         <div class="card-content">
            <div class="card-body">
               <form class="form form-vertical" method="post">
                  {% csrf_token %}

                  {% if form.non_field_errors %}
                  <div class="alert alert-danger">
                     {% for error in form.non_field_errors %}
                     {{ error }}
                     {% endfor %}
                  </div>
                  {% endif %}

                  <div class="form-body">
                     <div class="row">
                        <div class="col-12">
                           <div class="form-group has-icon-left">
                              <label for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                              <div class="position-relative">
                                 {{ form.name }}
                                 <div class="form-control-icon">
                                    <i class="bi bi-people"></i>
                                 </div>
                              </div>
                              {% if form.name.errors %}
                              <div class="text-danger small">{{ form.name.errors.0 }}</div>
                              {% endif %}
                           </div>
                        </div>

                        <div class="col-12">
                           <div class="form-group">
                              <label for="{{ form.permissions.id_for_label }}" class="form-label mb-2">
                                 {{ form.permissions.label }}
                              </label>
                              <div class="card border">
                                 <div class="card-body p-3" style="max-height: 800px; overflow-y: auto;">
                                    {% for category, perms in form.get_grouped_permissions %}
                                    <h6 class="mb-3 text-primary border-bottom pb-2 sticky-top bg-white pt-2">
                                       {{ category }}</h6>
                                    <div class="row mb-4">
                                       {% for widget in perms %}
                                                        <div class="col-12 col-md-6 col-lg-4">
                                                            <div class="form-check">
                                                                {{ widget.tag }}
                                                                <label class="form-check-label" for="{{ widget.id_for_label }}">
                                                                    {{ widget.custom_label|default:widget.choice_label }}
                                                                </label>
                                                            </div>
                                                        </div>
                                       {% endfor %}
                                    </div>
                                    {% endfor %}
                                 </div>
                              </div>
                              {% if form.permissions.errors %}
                              <div class="text-danger small">{{ form.permissions.errors.0 }}</div>
                              {% endif %}
                           </div>
                        </div>

                        <div class="col-12 d-flex justify-content-end mt-4">
                           <a href="{% url 'backoffice:group_list' %}" class="btn btn-light-secondary me-1 mb-1">
                              <i class="bi bi-x-circle me-2"></i>
                              Cancelar
                           </a>
                           <button type="submit" class="btn btn-primary me-1 mb-1">
                              <i class="bi bi-check-circle me-2"></i>
                              Guardar
                           </button>
                        </div>
                     </div>
                  </div>
               </form>
            </div>
         </div>
      </div>
   </section>
</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'backoffice/extensions/choices.js/public/assets/scripts/choices.js' %}"></script>
<script>
   document.addEventListener('DOMContentLoaded', function () {
      let choices = document.querySelectorAll('.choices');
      let initChoice;
      for (let i = 0; i < choices.length; i++) {
         if (choices[i].classList.contains("multiple-remove")) {
            initChoice = new Choices(choices[i],
               {
                  delimiter: ',',
                  editItems: true,
                  maxItemCount: -1,
                  removeItemButton: true,
               });
         } else {
            initChoice = new Choices(choices[i],
               {
                  delimiter: ',',
                  editItems: true,
                  maxItemCount: -1,
                  removeItemButton: true,
               });
         }
      }
   });
</script>
{% endblock %}